"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getDiscordEmojis = exports.getDiscordIdFromEmoji = exports.getDiscordEmoji = exports.getUnicodeEmoji = void 0;
const is_1 = require("./is");
const getTwemojiURL = (name, version = "v15.1.0") => `https://cdn.jsdelivr.net/gh/jdecked/twemoji@${version}/assets/72x72/${name}.png`;
const twemoji = /^(?:\d\ufe0f?\u20e3|\p{Emoji_Presentation})$/giu;
function getUnicodeEmoji(emoji) {
    if (!emoji) {
        return null;
    }
    const r = [];
    let [c, p, i] = [0, 0, 0];
    while (i < emoji.length) {
        c = emoji.charCodeAt(i++);
        if (p) {
            r.push(
            // @ts-ignore
            (0x10000 + ((p - 0xd800) << 10) + (c - 0xdc00)).toString(16));
            p = 0;
        }
        else if (c >= 0xd800 && c <= 0xdbff) {
            p = c;
        }
        else {
            // @ts-ignore
            r.push(c.toString(16));
        }
    }
    return r.join("-");
}
exports.getUnicodeEmoji = getUnicodeEmoji;
function getDiscordEmoji(emoji) {
    if (!emoji) {
        return null;
    }
    if (!emoji.id) {
        if (!twemoji.test(emoji.name || "")) {
            return null;
        }
        const emote = getUnicodeEmoji(emoji.name);
        if (!emote) {
            return null;
        }
        return {
            name: emoji.name,
            id: null,
            animated: false,
            url: getTwemojiURL(emote),
            raw: emoji.name,
        };
    }
    return {
        name: emoji.name,
        id: emoji.id,
        animated: emoji.animated,
        url: is_1.make.emojiURL(emoji.id, emoji.animated ? "gif" : "png"),
        raw: `<${emoji.animated ? "a" : ""}:${emoji.name}:${emoji.id}>`,
    };
}
exports.getDiscordEmoji = getDiscordEmoji;
function getDiscordIdFromEmoji(str) {
    if (!str.startsWith("<") && !str.endsWith(">")) {
        return "";
    }
    return str.split(">")[0].split(":")[2];
}
exports.getDiscordIdFromEmoji = getDiscordIdFromEmoji;
function getDiscordEmojis(str) {
    const matches = str.match(/<(?<animated>a)?:(?<name>\w{2,32}):(?<id>\d{17,21})>/gim);
    const twemojiMatches = str.match(twemoji);
    const emojis = [];
    if (matches?.length) {
        for (const e of matches) {
            const id = getDiscordIdFromEmoji(e);
            if (!is_1.is.string(id)) {
                continue;
            }
            const animated = e.startsWith("<a:") ? true : false;
            emojis.push({
                name: "unknown",
                url: is_1.make.emojiURL(id, animated ? "gif" : "png"),
                animated,
                matching: e,
            });
        }
    }
    if (twemojiMatches?.length) {
        for (const e of twemojiMatches) {
            const em = getUnicodeEmoji(e);
            if (!em) {
                continue;
            }
            emojis.push({
                name: e,
                url: getTwemojiURL(em),
                animated: false,
                matching: e,
            });
        }
    }
    return emojis;
}
exports.getDiscordEmojis = getDiscordEmojis;
